{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _events = _interopRequireDefault(require(\"events\"));\n\nvar POPUP = _interopRequireWildcard(require(\"../constants/popup\"));\n\nvar IFRAME = _interopRequireWildcard(require(\"../constants/iframe\"));\n\nvar UI = _interopRequireWildcard(require(\"../constants/ui\"));\n\nvar _showPopupRequest = require(\"./showPopupRequest\");\n\nvar _urlUtils = require(\"../utils/urlUtils\");\n\nvar _deferred = require(\"../utils/deferred\");\n\nfunction _getRequireWildcardCache(nodeInterop) {\n  if (typeof WeakMap !== \"function\") return null;\n  var cacheBabelInterop = new WeakMap();\n  var cacheNodeInterop = new WeakMap();\n  return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) {\n    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;\n  })(nodeInterop);\n}\n\nfunction _interopRequireWildcard(obj, nodeInterop) {\n  if (!nodeInterop && obj && obj.__esModule) {\n    return obj;\n  }\n\n  if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") {\n    return {\n      \"default\": obj\n    };\n  }\n\n  var cache = _getRequireWildcardCache(nodeInterop);\n\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n\n  var newObj = {};\n  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n\n  for (var key in obj) {\n    if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n\n  newObj[\"default\"] = obj;\n\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n\n  return newObj;\n} // const POPUP_REQUEST_TIMEOUT = 602;\n\n\nvar POPUP_REQUEST_TIMEOUT = 850;\nvar POPUP_CLOSE_INTERVAL = 500;\nvar POPUP_OPEN_TIMEOUT = 3000;\n\nvar PopupManager = /*#__PURE__*/function (_EventEmitter) {\n  (0, _inheritsLoose2[\"default\"])(PopupManager, _EventEmitter); // Window\n\n  function PopupManager(settings) {\n    var _this;\n\n    _this = _EventEmitter.call(this) || this;\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"requestTimeout\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"closeInterval\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"extensionTabId\", 0);\n    _this.settings = settings;\n    _this.origin = (0, _urlUtils.getOrigin)(settings.popupSrc);\n    _this.handleMessage = _this.handleMessage.bind((0, _assertThisInitialized2[\"default\"])(_this));\n    _this.iframeHandshake = (0, _deferred.create)(IFRAME.LOADED);\n\n    if (_this.settings.env === 'webextension') {\n      _this.handleExtensionConnect = _this.handleExtensionConnect.bind((0, _assertThisInitialized2[\"default\"])(_this));\n      _this.handleExtensionMessage = _this.handleExtensionMessage.bind((0, _assertThisInitialized2[\"default\"])(_this)); // $FlowIssue chrome not declared outside\n\n      chrome.runtime.onConnect.addListener(_this.handleExtensionConnect);\n    }\n\n    window.addEventListener('message', _this.handleMessage, false);\n    return _this;\n  }\n\n  var _proto = PopupManager.prototype;\n\n  _proto.request = function request(lazyLoad) {\n    var _this2 = this;\n\n    if (lazyLoad === void 0) {\n      lazyLoad = false;\n    } // popup request\n    // TODO: ie - open immediately and hide it but post handshake after timeout\n    // bring popup window to front\n\n\n    if (this.locked) {\n      if (this._window) {\n        if (this.settings.env === 'webextension') {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.update(this._window.id, {\n            active: true\n          });\n        } else {\n          this._window.focus();\n        }\n      }\n\n      return;\n    }\n\n    var openFn = this.open.bind(this);\n    this.locked = true;\n\n    if (!this.settings.supportedBrowser) {\n      openFn();\n    } else {\n      var timeout = lazyLoad || this.settings.env === 'webextension' ? 1 : POPUP_REQUEST_TIMEOUT;\n      this.requestTimeout = window.setTimeout(function () {\n        _this2.requestTimeout = 0;\n        openFn(lazyLoad);\n      }, timeout);\n    }\n  };\n\n  _proto.cancel = function cancel() {\n    this.close();\n  };\n\n  _proto.unlock = function unlock() {\n    this.locked = false;\n  };\n\n  _proto.open = function open(lazyLoad) {\n    var _this3 = this;\n\n    var src = this.settings.popupSrc;\n\n    if (!this.settings.supportedBrowser) {\n      this.openWrapper(src + \"#unsupported\");\n      return;\n    }\n\n    this.popupPromise = (0, _deferred.create)(POPUP.LOADED);\n    this.openWrapper(lazyLoad ? src + \"#loading\" : src);\n    this.closeInterval = window.setInterval(function () {\n      if (!_this3._window) return;\n\n      if (_this3.settings.env === 'webextension') {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.get(_this3._window.id, function (tab) {\n          if (!tab) {\n            _this3.close();\n\n            _this3.emit(POPUP.CLOSED);\n          }\n        });\n      } else if (_this3._window.closed) {\n        _this3.close();\n\n        _this3.emit(POPUP.CLOSED);\n      }\n    }, POPUP_CLOSE_INTERVAL); // open timeout will be cancelled by POPUP.BOOTSTRAP message\n\n    this.openTimeout = window.setTimeout(function () {\n      _this3.close();\n\n      (0, _showPopupRequest.showPopupRequest)(_this3.open.bind(_this3), function () {\n        _this3.emit(POPUP.CLOSED);\n      });\n    }, POPUP_OPEN_TIMEOUT);\n  };\n\n  _proto.openWrapper = function openWrapper(url) {\n    var _this4 = this;\n\n    if (this.settings.env === 'webextension') {\n      // $FlowIssue chrome not declared outside\n      chrome.windows.getCurrent(null, function (currentWindow) {\n        // Request coming from extension popup,\n        // create new window above instead of opening new tab\n        if (currentWindow.type !== 'normal') {\n          // $FlowIssue chrome not declared outside\n          chrome.windows.create({\n            url: url\n          }, function (newWindow) {\n            // $FlowIssue chrome not declared outside\n            chrome.tabs.query({\n              windowId: newWindow.id,\n              active: true\n            }, function (tabs) {\n              // eslint-disable-next-line prefer-destructuring\n              _this4._window = tabs[0];\n            });\n          });\n        } else {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.query({\n            currentWindow: true,\n            active: true\n          }, function (tabs) {\n            _this4.extensionTabId = tabs[0].id; // $FlowIssue chrome not declared outside\n\n            chrome.tabs.create({\n              url: url,\n              index: tabs[0].index + 1\n            }, function (tab) {\n              _this4._window = tab;\n            });\n          });\n        }\n      });\n    } else if (this.settings.env === 'electron') {\n      this._window = window.open(url, 'modal');\n    } else {\n      this._window = window.open('', '_blank');\n\n      if (this._window) {\n        this._window.location.href = url; // otherwise android/chrome loose window.opener reference\n      }\n    }\n  };\n\n  _proto.handleExtensionConnect = function handleExtensionConnect(port) {\n    if (port.name !== 'trezor-connect') return;\n\n    if (!this._window || this._window && this._window.id !== port.sender.tab.id) {\n      port.disconnect();\n      return;\n    } // since POPUP.BOOTSTRAP will not be handled by \"handleMessage\" we need to threat \"content-script\" connection as the same event\n    // popup is opened properly, now wait for POPUP.LOADED message (in this case handled by \"handleExtensionMessage\")\n\n\n    window.clearTimeout(this.openTimeout);\n    this.extensionPort = port; // $FlowIssue need to update ChromePort definition\n\n    this.extensionPort.onMessage.addListener(this.handleExtensionMessage);\n  };\n\n  _proto.handleExtensionMessage = function handleExtensionMessage(message) {\n    var _this5 = this;\n\n    if (!this.extensionPort) return;\n    var port = this.extensionPort;\n    var data = message.data;\n    if (!data || typeof data !== 'object') return;\n\n    if (data.type === POPUP.ERROR) {\n      // handle popup error\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      }\n\n      this.iframeHandshake.promise.then(function (useBroadcastChannel) {\n        port.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this5.settings,\n            useBroadcastChannel: useBroadcastChannel\n          }\n        });\n      });\n    } else if (data.type === POPUP.EXTENSION_USB_PERMISSIONS) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.query({\n        currentWindow: true,\n        active: true\n      }, function (tabs) {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.create({\n          url: 'trezor-usb-permissions.html',\n          index: tabs[0].index + 1\n        }, function (_tab) {// do nothing\n        });\n      });\n    } else if (data.type === POPUP.CLOSE_WINDOW) {\n      this.emit(POPUP.CLOSED);\n      this.close();\n    }\n  };\n\n  _proto.handleMessage = function handleMessage(message) {\n    var _this6 = this; // ignore messages from domain other then popup origin and without data\n    // const data: CoreMessage = message.data;\n\n\n    var data = message.data;\n    if ((0, _urlUtils.getOrigin)(message.origin) !== this.origin || !data || typeof data !== 'object') return;\n\n    if (data.type === IFRAME.LOADED) {\n      var useBroadcastChannel = data.payload && typeof data.payload.useBroadcastChannel === 'boolean' ? data.payload.useBroadcastChannel : false;\n      this.iframeHandshake.resolve(useBroadcastChannel);\n    } else if (data.type === POPUP.BOOTSTRAP) {\n      // popup is opened properly, now wait for POPUP.LOADED message\n      window.clearTimeout(this.openTimeout);\n    } else if (data.type === POPUP.ERROR && this._window) {\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      } // popup is successfully loaded\n\n\n      this.iframeHandshake.promise.then(function (useBroadcastChannel) {\n        _this6._window.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this6.settings,\n            useBroadcastChannel: useBroadcastChannel\n          }\n        }, _this6.origin);\n      }); // send ConnectSettings to popup\n      // note this settings and iframe.ConnectSettings could be different (especially: origin, popup, webusb, debug)\n      // now popup is able to load assets\n    } else if (data.type === POPUP.CANCEL_POPUP_REQUEST || data.type === UI.CLOSE_UI_WINDOW) {\n      this.close();\n    }\n  };\n\n  _proto.close = function close() {\n    this.locked = false;\n    this.popupPromise = undefined;\n\n    if (this.requestTimeout) {\n      window.clearTimeout(this.requestTimeout);\n      this.requestTimeout = 0;\n    }\n\n    if (this.openTimeout) {\n      window.clearTimeout(this.openTimeout);\n      this.openTimeout = 0;\n    }\n\n    if (this.closeInterval) {\n      window.clearInterval(this.closeInterval);\n      this.closeInterval = 0;\n    }\n\n    if (this.extensionPort) {\n      this.extensionPort.disconnect();\n      this.extensionPort = null;\n    } // switch to previously focused tab\n\n\n    if (this.extensionTabId) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.update(this.extensionTabId, {\n        active: true\n      });\n      this.extensionTabId = 0;\n    }\n\n    if (this._window) {\n      if (this.settings.env === 'webextension') {\n        // eslint-disable-next-line no-unused-vars\n        var _e = chrome.runtime.lastError; // $FlowIssue chrome not declared outside\n\n        chrome.tabs.remove(this._window.id, function () {\n          // eslint-disable-next-line no-unused-vars\n          _e = chrome.runtime.lastError;\n        });\n      } else {\n        this._window.close();\n      }\n\n      this._window = null;\n    }\n  };\n\n  _proto.postMessage = /*#__PURE__*/function () {\n    var _postMessage = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(message) {\n      var _this7 = this;\n\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!(!this._window && message.type !== UI.REQUEST_UI_WINDOW && this.openTimeout)) {\n                _context.next = 4;\n                break;\n              }\n\n              this.close();\n              (0, _showPopupRequest.showPopupRequest)(this.open.bind(this), function () {\n                _this7.emit(POPUP.CLOSED);\n              });\n              return _context.abrupt(\"return\");\n\n            case 4:\n              if (!this.popupPromise) {\n                _context.next = 7;\n                break;\n              }\n\n              _context.next = 7;\n              return this.popupPromise.promise;\n\n            case 7:\n              // post message to popup window\n              if (this._window) {\n                this._window.postMessage(message, this.origin);\n              }\n\n            case 8:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, this);\n    }));\n\n    function postMessage(_x) {\n      return _postMessage.apply(this, arguments);\n    }\n\n    return postMessage;\n  }();\n\n  return PopupManager;\n}(_events[\"default\"]);\n\nexports[\"default\"] = PopupManager;","map":{"version":3,"names":["_interopRequireDefault","require","exports","__esModule","_regenerator","_asyncToGenerator2","_assertThisInitialized2","_inheritsLoose2","_defineProperty2","_events","POPUP","_interopRequireWildcard","IFRAME","UI","_showPopupRequest","_urlUtils","_deferred","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","POPUP_REQUEST_TIMEOUT","POPUP_CLOSE_INTERVAL","POPUP_OPEN_TIMEOUT","PopupManager","_EventEmitter","settings","_this","origin","getOrigin","popupSrc","handleMessage","bind","iframeHandshake","create","LOADED","env","handleExtensionConnect","handleExtensionMessage","chrome","runtime","onConnect","addListener","window","addEventListener","_proto","request","lazyLoad","_this2","locked","_window","tabs","update","id","active","focus","openFn","open","supportedBrowser","timeout","requestTimeout","setTimeout","cancel","close","unlock","_this3","src","openWrapper","popupPromise","closeInterval","setInterval","tab","emit","CLOSED","closed","openTimeout","showPopupRequest","url","_this4","windows","getCurrent","currentWindow","type","newWindow","query","windowId","extensionTabId","index","location","href","port","name","sender","disconnect","clearTimeout","extensionPort","onMessage","message","_this5","data","ERROR","errorMessage","payload","error","resolve","promise","then","useBroadcastChannel","postMessage","INIT","EXTENSION_USB_PERMISSIONS","_tab","CLOSE_WINDOW","_this6","BOOTSTRAP","CANCEL_POPUP_REQUEST","CLOSE_UI_WINDOW","undefined","clearInterval","_e","lastError","remove","_postMessage","mark","_callee","_this7","wrap","_callee$","_context","prev","next","REQUEST_UI_WINDOW","abrupt","stop","_x","apply","arguments"],"sources":["/Users/jjestrella/DNERO_Protocol/dnerowebwallet/node_modules/trezor-connect/lib/popup/PopupManager.js"],"sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _events = _interopRequireDefault(require(\"events\"));\n\nvar POPUP = _interopRequireWildcard(require(\"../constants/popup\"));\n\nvar IFRAME = _interopRequireWildcard(require(\"../constants/iframe\"));\n\nvar UI = _interopRequireWildcard(require(\"../constants/ui\"));\n\nvar _showPopupRequest = require(\"./showPopupRequest\");\n\nvar _urlUtils = require(\"../utils/urlUtils\");\n\nvar _deferred = require(\"../utils/deferred\");\n\nfunction _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== \"function\") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }\n\nfunction _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") { return { \"default\": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj[\"default\"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }\n\n// const POPUP_REQUEST_TIMEOUT = 602;\nvar POPUP_REQUEST_TIMEOUT = 850;\nvar POPUP_CLOSE_INTERVAL = 500;\nvar POPUP_OPEN_TIMEOUT = 3000;\n\nvar PopupManager = /*#__PURE__*/function (_EventEmitter) {\n  (0, _inheritsLoose2[\"default\"])(PopupManager, _EventEmitter);\n\n  // Window\n  function PopupManager(settings) {\n    var _this;\n\n    _this = _EventEmitter.call(this) || this;\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"requestTimeout\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"closeInterval\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"extensionTabId\", 0);\n    _this.settings = settings;\n    _this.origin = (0, _urlUtils.getOrigin)(settings.popupSrc);\n    _this.handleMessage = _this.handleMessage.bind((0, _assertThisInitialized2[\"default\"])(_this));\n    _this.iframeHandshake = (0, _deferred.create)(IFRAME.LOADED);\n\n    if (_this.settings.env === 'webextension') {\n      _this.handleExtensionConnect = _this.handleExtensionConnect.bind((0, _assertThisInitialized2[\"default\"])(_this));\n      _this.handleExtensionMessage = _this.handleExtensionMessage.bind((0, _assertThisInitialized2[\"default\"])(_this)); // $FlowIssue chrome not declared outside\n\n      chrome.runtime.onConnect.addListener(_this.handleExtensionConnect);\n    }\n\n    window.addEventListener('message', _this.handleMessage, false);\n    return _this;\n  }\n\n  var _proto = PopupManager.prototype;\n\n  _proto.request = function request(lazyLoad) {\n    var _this2 = this;\n\n    if (lazyLoad === void 0) {\n      lazyLoad = false;\n    }\n\n    // popup request\n    // TODO: ie - open immediately and hide it but post handshake after timeout\n    // bring popup window to front\n    if (this.locked) {\n      if (this._window) {\n        if (this.settings.env === 'webextension') {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.update(this._window.id, {\n            active: true\n          });\n        } else {\n          this._window.focus();\n        }\n      }\n\n      return;\n    }\n\n    var openFn = this.open.bind(this);\n    this.locked = true;\n\n    if (!this.settings.supportedBrowser) {\n      openFn();\n    } else {\n      var timeout = lazyLoad || this.settings.env === 'webextension' ? 1 : POPUP_REQUEST_TIMEOUT;\n      this.requestTimeout = window.setTimeout(function () {\n        _this2.requestTimeout = 0;\n        openFn(lazyLoad);\n      }, timeout);\n    }\n  };\n\n  _proto.cancel = function cancel() {\n    this.close();\n  };\n\n  _proto.unlock = function unlock() {\n    this.locked = false;\n  };\n\n  _proto.open = function open(lazyLoad) {\n    var _this3 = this;\n\n    var src = this.settings.popupSrc;\n\n    if (!this.settings.supportedBrowser) {\n      this.openWrapper(src + \"#unsupported\");\n      return;\n    }\n\n    this.popupPromise = (0, _deferred.create)(POPUP.LOADED);\n    this.openWrapper(lazyLoad ? src + \"#loading\" : src);\n    this.closeInterval = window.setInterval(function () {\n      if (!_this3._window) return;\n\n      if (_this3.settings.env === 'webextension') {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.get(_this3._window.id, function (tab) {\n          if (!tab) {\n            _this3.close();\n\n            _this3.emit(POPUP.CLOSED);\n          }\n        });\n      } else if (_this3._window.closed) {\n        _this3.close();\n\n        _this3.emit(POPUP.CLOSED);\n      }\n    }, POPUP_CLOSE_INTERVAL); // open timeout will be cancelled by POPUP.BOOTSTRAP message\n\n    this.openTimeout = window.setTimeout(function () {\n      _this3.close();\n\n      (0, _showPopupRequest.showPopupRequest)(_this3.open.bind(_this3), function () {\n        _this3.emit(POPUP.CLOSED);\n      });\n    }, POPUP_OPEN_TIMEOUT);\n  };\n\n  _proto.openWrapper = function openWrapper(url) {\n    var _this4 = this;\n\n    if (this.settings.env === 'webextension') {\n      // $FlowIssue chrome not declared outside\n      chrome.windows.getCurrent(null, function (currentWindow) {\n        // Request coming from extension popup,\n        // create new window above instead of opening new tab\n        if (currentWindow.type !== 'normal') {\n          // $FlowIssue chrome not declared outside\n          chrome.windows.create({\n            url: url\n          }, function (newWindow) {\n            // $FlowIssue chrome not declared outside\n            chrome.tabs.query({\n              windowId: newWindow.id,\n              active: true\n            }, function (tabs) {\n              // eslint-disable-next-line prefer-destructuring\n              _this4._window = tabs[0];\n            });\n          });\n        } else {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.query({\n            currentWindow: true,\n            active: true\n          }, function (tabs) {\n            _this4.extensionTabId = tabs[0].id; // $FlowIssue chrome not declared outside\n\n            chrome.tabs.create({\n              url: url,\n              index: tabs[0].index + 1\n            }, function (tab) {\n              _this4._window = tab;\n            });\n          });\n        }\n      });\n    } else if (this.settings.env === 'electron') {\n      this._window = window.open(url, 'modal');\n    } else {\n      this._window = window.open('', '_blank');\n\n      if (this._window) {\n        this._window.location.href = url; // otherwise android/chrome loose window.opener reference\n      }\n    }\n  };\n\n  _proto.handleExtensionConnect = function handleExtensionConnect(port) {\n    if (port.name !== 'trezor-connect') return;\n\n    if (!this._window || this._window && this._window.id !== port.sender.tab.id) {\n      port.disconnect();\n      return;\n    } // since POPUP.BOOTSTRAP will not be handled by \"handleMessage\" we need to threat \"content-script\" connection as the same event\n    // popup is opened properly, now wait for POPUP.LOADED message (in this case handled by \"handleExtensionMessage\")\n\n\n    window.clearTimeout(this.openTimeout);\n    this.extensionPort = port; // $FlowIssue need to update ChromePort definition\n\n    this.extensionPort.onMessage.addListener(this.handleExtensionMessage);\n  };\n\n  _proto.handleExtensionMessage = function handleExtensionMessage(message) {\n    var _this5 = this;\n\n    if (!this.extensionPort) return;\n    var port = this.extensionPort;\n    var data = message.data;\n    if (!data || typeof data !== 'object') return;\n\n    if (data.type === POPUP.ERROR) {\n      // handle popup error\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      }\n\n      this.iframeHandshake.promise.then(function (useBroadcastChannel) {\n        port.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this5.settings,\n            useBroadcastChannel: useBroadcastChannel\n          }\n        });\n      });\n    } else if (data.type === POPUP.EXTENSION_USB_PERMISSIONS) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.query({\n        currentWindow: true,\n        active: true\n      }, function (tabs) {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.create({\n          url: 'trezor-usb-permissions.html',\n          index: tabs[0].index + 1\n        }, function (_tab) {// do nothing\n        });\n      });\n    } else if (data.type === POPUP.CLOSE_WINDOW) {\n      this.emit(POPUP.CLOSED);\n      this.close();\n    }\n  };\n\n  _proto.handleMessage = function handleMessage(message) {\n    var _this6 = this;\n\n    // ignore messages from domain other then popup origin and without data\n    // const data: CoreMessage = message.data;\n    var data = message.data;\n    if ((0, _urlUtils.getOrigin)(message.origin) !== this.origin || !data || typeof data !== 'object') return;\n\n    if (data.type === IFRAME.LOADED) {\n      var useBroadcastChannel = data.payload && typeof data.payload.useBroadcastChannel === 'boolean' ? data.payload.useBroadcastChannel : false;\n      this.iframeHandshake.resolve(useBroadcastChannel);\n    } else if (data.type === POPUP.BOOTSTRAP) {\n      // popup is opened properly, now wait for POPUP.LOADED message\n      window.clearTimeout(this.openTimeout);\n    } else if (data.type === POPUP.ERROR && this._window) {\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      } // popup is successfully loaded\n\n\n      this.iframeHandshake.promise.then(function (useBroadcastChannel) {\n        _this6._window.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this6.settings,\n            useBroadcastChannel: useBroadcastChannel\n          }\n        }, _this6.origin);\n      }); // send ConnectSettings to popup\n      // note this settings and iframe.ConnectSettings could be different (especially: origin, popup, webusb, debug)\n      // now popup is able to load assets\n    } else if (data.type === POPUP.CANCEL_POPUP_REQUEST || data.type === UI.CLOSE_UI_WINDOW) {\n      this.close();\n    }\n  };\n\n  _proto.close = function close() {\n    this.locked = false;\n    this.popupPromise = undefined;\n\n    if (this.requestTimeout) {\n      window.clearTimeout(this.requestTimeout);\n      this.requestTimeout = 0;\n    }\n\n    if (this.openTimeout) {\n      window.clearTimeout(this.openTimeout);\n      this.openTimeout = 0;\n    }\n\n    if (this.closeInterval) {\n      window.clearInterval(this.closeInterval);\n      this.closeInterval = 0;\n    }\n\n    if (this.extensionPort) {\n      this.extensionPort.disconnect();\n      this.extensionPort = null;\n    } // switch to previously focused tab\n\n\n    if (this.extensionTabId) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.update(this.extensionTabId, {\n        active: true\n      });\n      this.extensionTabId = 0;\n    }\n\n    if (this._window) {\n      if (this.settings.env === 'webextension') {\n        // eslint-disable-next-line no-unused-vars\n        var _e = chrome.runtime.lastError; // $FlowIssue chrome not declared outside\n\n        chrome.tabs.remove(this._window.id, function () {\n          // eslint-disable-next-line no-unused-vars\n          _e = chrome.runtime.lastError;\n        });\n      } else {\n        this._window.close();\n      }\n\n      this._window = null;\n    }\n  };\n\n  _proto.postMessage = /*#__PURE__*/function () {\n    var _postMessage = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(message) {\n      var _this7 = this;\n\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!(!this._window && message.type !== UI.REQUEST_UI_WINDOW && this.openTimeout)) {\n                _context.next = 4;\n                break;\n              }\n\n              this.close();\n              (0, _showPopupRequest.showPopupRequest)(this.open.bind(this), function () {\n                _this7.emit(POPUP.CLOSED);\n              });\n              return _context.abrupt(\"return\");\n\n            case 4:\n              if (!this.popupPromise) {\n                _context.next = 7;\n                break;\n              }\n\n              _context.next = 7;\n              return this.popupPromise.promise;\n\n            case 7:\n              // post message to popup window\n              if (this._window) {\n                this._window.postMessage(message, this.origin);\n              }\n\n            case 8:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, this);\n    }));\n\n    function postMessage(_x) {\n      return _postMessage.apply(this, arguments);\n    }\n\n    return postMessage;\n  }();\n\n  return PopupManager;\n}(_events[\"default\"]);\n\nexports[\"default\"] = PopupManager;"],"mappings":"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"},"metadata":{},"sourceType":"script"}